# Improve `install.sh` safety and rerun behavior

## Objective

- Make `install.sh` idempotent, safer on existing machines, and easier to maintain while preserving current setup behavior.

## Recommended implementation

1. Add installer scaffolding in `install.sh`.
   - Introduce `log_info/log_warn/log_error`, a `run_step` wrapper, and `--dry-run`, `--strict`, `--non-interactive` flags.
   - Add `trap`-based failure reporting and a final summary of completed/skipped/failed steps.
2. Fix high-impact correctness issues first.
   - Make repo bootstrap idempotent: clone only when `~/.dotfiles` is absent; validate existing repo origin when present.
   - Replace `brew bundle install ... || true` with explicit error policy:
     - default mode: warn and continue
     - strict mode: fail with non-zero exit.
   - Make Git include idempotent using `git config --global --get-all include.path` checks before add.
3. Centralize symlink logic.
   - Add `link_with_backup <src> <dst> <required|optional>` helper that validates source existence, no-ops when already correct, and backs up conflicting destinations.
   - Convert repeated `ln -snf` blocks to helper-driven calls while keeping existing command/platform guards.
4. Harden privileged and interactive steps.
   - For zsh setup: only modify `/etc/shells` and run `chsh` when needed; avoid blocking in non-interactive mode if `sudo` cannot prompt.
   - Gate interactive commands (`ya pkg install`) behind TTY/flag checks so CI/automation runs do not hang.
   - Keep service restarts best-effort with clear warnings when services are unavailable.
5. Add post-run verification output.
   - Print a concise checklist of important symlinks and skipped actions (e.g., skipped `chsh`, skipped yazi packages).

## Critical files to modify

- `install.sh`
- `README.md` (or install docs location) to document new flags and rerun behavior.

## Verification plan

1. Static validation.
   - Run `bash -n install.sh`.
   - Run `shellcheck install.sh`.
2. End-to-end rerun safety (Linux + macOS).
   - Run installer in a clean test home (`HOME=$(mktemp -d)`) once, then run it again.
   - Confirm second run is mostly no-op (no duplicate Git include, no broken symlinks, no clone failure).
3. Behavior checks.
   - Confirm brew failures are visible and follow strict/default policy.
   - Confirm non-interactive mode does not block on `sudo`, `chsh`, or `ya pkg install`.
4. Read-only MCP checks after edits.
   - Use `Read`/`Grep` to verify `install.sh` no longer contains `brew bundle ... || true`, and that helper functions are used consistently across app links.
